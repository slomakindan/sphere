<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UNIT Core v0.2 - Audio & Export</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        canvas { display: block; }
        
        /* UI –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        #ui-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            color: #fff;
        }
        button, input[type=file] {
            display: block;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: #222;
            color: #fff;
            border: 1px solid #555;
            cursor: pointer;
            width: 100%;
            font-size: 12px;
        }
        button:hover { background: #444; }
        #status { font-size: 11px; color: #aaa; margin-bottom: 10px;}
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="ui-panel">
    <div id="status">Waiting for audio...</div>
    <input type="file" id="audioInput" accept="audio/*" class="hidden">
    <button id="loadAudioBtn">üìÅ Load Audio File</button>
    <button id="playPauseBtn" disabled>‚ñ∂ Play / Pause</button>
    <hr style="border-color: #333; margin: 15px 0;">
    <button id="exportBtn">üì∑ Snapshot 4K Image</button>
</div>


<script type="module">
import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
import { OrbitControls } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/controls/OrbitControls.js';

// ==========================================
// –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –ê–£–î–ò–û
// ==========================================
let audioListener, sound, audioAnalyser;
let isAudioPlaying = false;
let audioData = { level: 0 }; // –î–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–π–¥—É—Ç –≤ —à–µ–π–¥–µ—Ä

// ==========================================
// SHADER CODE (–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π)
// ==========================================

const vertexShader = `
    uniform float uTime;
    uniform float uSpeed;
    uniform float uNoiseDensity;
    uniform float uNoiseStrength;
    uniform float uAudioLevel; // –ù–û–í–ê–Ø –ü–ï–†–ï–ú–ï–ù–ù–ê–Ø: –£—Ä–æ–≤–µ–Ω—å –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –∑–≤—É–∫–∞ (0.0 - 1.0)
    
    varying vec3 vNormal;

    // --- Simplex Noise (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è) ---
    vec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
    vec4 mod289(vec4 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
    vec4 permute(vec4 x) { return mod289(((x*34.0)+1.0)*x); }
    vec4 taylorInvSqrt(vec4 r) { return 1.79284291400159 - 0.85373472095314 * r; }
    float snoise(vec3 v) {
        const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;
        const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);
        vec3 i  = floor(v + dot(v, C.yyy) );
        vec3 x0 = v - i + dot(i, C.xxx) ;
        vec3 g = step(x0.yzx, x0.xyz);
        vec3 l = 1.0 - g;
        vec3 i1 = min( g.xyz, l.zxy );
        vec3 i2 = max( g.xyz, l.zxy );
        vec3 x1 = x0 - i1 + C.xxx;
        vec3 x2 = x0 - i2 + C.yyy; 
        vec3 x3 = x0 - D.yyy;
        i = mod289(i);
        vec4 p = permute( permute( permute( 
                    i.z + vec4(0.0, i1.z, i2.z, 1.0 ))
                + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) 
                + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));
        float n_ = 0.142857142857; 
        vec3  ns = n_ * D.wyz - D.xzx;
        vec4 j = p - 49.0 * floor(p * ns.z * ns.z); 
        vec4 x_ = floor(j * ns.z);
        vec4 y_ = floor(j - 7.0 * x_ ); 
        vec4 x = x_ *ns.x + ns.yyyy;
        vec4 y = y_ *ns.x + ns.yyyy;
        vec4 h = 1.0 - abs(x) - abs(y);
        vec4 b0 = vec4( x.xy, y.xy );
        vec4 b1 = vec4( x.zw, y.zw );
        vec4 s0 = floor(b0)*2.0 + 1.0;
        vec4 s1 = floor(b1)*2.0 + 1.0;
        vec4 sh = -step(h, vec4(0.0));
        vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;
        vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;
        vec3 p0 = vec3(a0.xy,h.x);
        vec3 p1 = vec3(a0.zw,h.y);
        vec3 p2 = vec3(a1.xy,h.z);
        vec3 p3 = vec3(a1.zw,h.w);
        vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));
        p0 *= norm.x;
        p1 *= norm.y;
        p2 *= norm.z;
        p3 *= norm.w;
        vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);
        m = m * m;
        return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), dot(p2,x2), dot(p3,x3) ) );
    }
    // ---------------------------------------------------

    void main() {
        vNormal = normal;
        vec3 newPosition = position;

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–∞–∑–æ–≤–æ–≥–æ —à—É–º–∞
        // –î–æ–±–∞–≤–ª—è–µ–º uAudioLevel –∫ —Å–∫–æ—Ä–æ—Å—Ç–∏, —á—Ç–æ–±—ã –ø—Ä–∏ –≥—Ä–æ–º–∫–æ–º –∑–≤—É–∫–µ —à—É–º –¥–≤–∏–≥–∞–ª—Å—è –±—ã—Å—Ç—Ä–µ–µ
        float dynamicSpeed = uSpeed + (uAudioLevel * 0.5); 
        float noise = snoise(normal * uNoiseDensity + vec3(uTime * dynamicSpeed));

        // –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –ó–í–£–ö–ê –í –°–ú–ï–©–ï–ù–ò–ï
        // –ë–∞–∑–æ–≤–∞—è —Å–∏–ª–∞ —à—É–º–∞ + –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π "–ø–∏–Ω–æ–∫" –æ—Ç –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –∑–≤—É–∫–∞
        float totalStrength = uNoiseStrength + (uAudioLevel * 0.8); 
        
        newPosition += normal * noise * totalStrength;

        gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0);
        // –†–∞–∑–º–µ—Ä —Ç–æ—á–∫–∏ —Ç–æ–∂–µ —Å–ª–µ–≥–∫–∞ –ø—É–ª—å—Å–∏—Ä—É–µ—Ç –æ—Ç –∑–≤—É–∫–∞
        gl_PointSize = 2.0 + (uAudioLevel * 1.5); 
    }
`;

const fragmentShader = `
    uniform vec3 uColor;
    void main() {
        float dist = length(gl_PointCoord - vec2(0.5));
        if (dist > 0.5) discard;
        gl_FragColor = vec4(uColor, 1.0);
    }
`;


// ==========================================
// THREE.JS SETUP
// ==========================================
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
camera.position.z = 3.5;

// –í–∞–∂–Ω–æ: preserveDrawingBuffer: true –Ω—É–∂–µ–Ω –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setClearColor(0x000000, 1); 
document.body.appendChild(renderer.domElement);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

// --- –ù–ê–°–¢–†–û–ô–ö–ò –Ø–î–†–ê ---
const unitSettings = {
    speed: 0.15,
    noiseDensity: 1.2,
    noiseStrength: 0.2, 
    color: new THREE.Color(0xf2f4f7) // White Base
};

const geometry = new THREE.IcosahedronGeometry(1, 80); // –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è 80 –¥–ª—è –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª-–≤–∞ —Ç–æ—á–µ–∫

const material = new THREE.ShaderMaterial({
    vertexShader: vertexShader,
    fragmentShader: fragmentShader,
    uniforms: {
        uTime: { value: 0 },
        uSpeed: { value: unitSettings.speed },
        uNoiseDensity: { value: unitSettings.noiseDensity },
        uNoiseStrength: { value: unitSettings.noiseStrength },
        uColor: { value: unitSettings.color },
        uAudioLevel: { value: 0.0 } // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω—É–ª–µ–º
    },
    transparent: true,
    depthTest: false
});

const sphereParticles = new THREE.Points(geometry, material);
scene.add(sphereParticles);


// ==========================================
// –ê–£–î–ò–û –°–ò–°–¢–ï–ú–ê
// ==========================================
function setupAudio() {
    audioListener = new THREE.AudioListener();
    camera.add(audioListener);

    sound = new THREE.Audio(audioListener);
    // FFT Size –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞. 
    // –î–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –æ–±—â–µ–π –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ 128 –∏–ª–∏ 256.
    audioAnalyser = new THREE.AudioAnalyser(sound, 256); 
    
    document.getElementById('status').innerText = "Audio System Ready. Load a file.";
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
document.getElementById('loadAudioBtn').addEventListener('click', () => {
    document.getElementById('audioInput').click();
});

document.getElementById('audioInput').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (!file) return;

    document.getElementById('status').innerText = "Loading audio...";
    
    // –ï—Å–ª–∏ –∞—É–¥–∏–æ –µ—â–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º
    if (!audioListener) setupAudio();
    
    // –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —É–∂–µ –∏–≥—Ä–∞–µ—Ç, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
    if (sound.isPlaying) sound.stop();

    const loader = new THREE.AudioLoader();
    loader.load(URL.createObjectURL(file), function(buffer) {
        sound.setBuffer(buffer);
        sound.setLoop(true);
        sound.setVolume(1.0);
        sound.play();
        isAudioPlaying = true;
        document.getElementById('playPauseBtn').innerText = "‚ùö‚ùö Pause";
        document.getElementById('playPauseBtn').disabled = false;
        document.getElementById('status').innerText = `Playing: ${file.name}`;
    });
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Play/Pause
document.getElementById('playPauseBtn').addEventListener('click', function() {
    if (isAudioPlaying) {
        sound.pause();
        this.innerText = "‚ñ∂ Play";
    } else {
        sound.play();
        this.innerText = "‚ùö‚ùö Pause";
    }
    isAudioPlaying = !isAudioPlaying;
});


// ==========================================
// –§–£–ù–ö–¶–ò–Ø –≠–ö–°–ü–û–†–¢–ê –í –í–´–°–û–ö–û–ú –†–ê–ó–†–ï–®–ï–ù–ò–ò
// ==========================================
function exportHighRes() {
    const targetWidth = 3840; // 4K Width
    const targetHeight = 2160; // 4K Height
    
    // 1. –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä
    const originalSize = new THREE.Vector2();
    renderer.getSize(originalSize);
    const originalAspect = camera.aspect;

    // 2. –ò–∑–º–µ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä —Ä–µ–Ω–¥–µ—Ä–∞ –∏ –∫–∞–º–µ—Ä—ã –ø–æ–¥ 4K
    renderer.setSize(targetWidth, targetHeight);
    camera.aspect = targetWidth / targetHeight;
    camera.updateProjectionMatrix();

    // 3. –†–µ–Ω–¥–µ—Ä–∏–º –æ–¥–∏–Ω –∫–∞–¥—Ä –≤ –≤—ã—Å–æ–∫–æ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏
    renderer.render(scene, camera);

    // 4. –ü–æ–ª—É—á–∞–µ–º Data URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const dataURL = renderer.domElement.toDataURL("image/png");

    // 5. –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    const link = document.createElement('a');
    link.href = dataURL;
    link.download = `UNIT-Core-Snapshot-${Date.now()}.png`;
    link.click();

    // 6. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    renderer.setSize(originalSize.x, originalSize.y);
    camera.aspect = originalAspect;
    camera.updateProjectionMatrix();
}

document.getElementById('exportBtn').addEventListener('click', exportHighRes);


// ==========================================
// ANIMATION LOOP
// ==========================================
const clock = new THREE.Clock();

function animate() {
    requestAnimationFrame(animate);
    const elapsedTime = clock.getElapsedTime();

    // --- –ê–ù–ê–õ–ò–ó –ó–í–£–ö–ê ---
    if (audioAnalyser && isAudioPlaying) {
        // –ü–æ–ª—É—á–∞–µ–º —Å—Ä–µ–¥–Ω—é—é –≥—Ä–æ–º–∫–æ—Å—Ç—å –≤—Å–µ—Ö —á–∞—Å—Ç–æ—Ç (–æ—Ç 0 –¥–æ 256)
        const averageFreq = audioAnalyser.getAverageFrequency(); 
        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∫ –¥–∏–∞–ø–∞–∑–æ–Ω—É 0.0 - 1.0
        audioData.level = averageFreq / 150.0; 
        // –ù–µ–±–æ–ª—å—à–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ –¥–µ—Ä–≥–∞–ª–æ—Å—å —Å–ª–∏—à–∫–æ–º —Ä–µ–∑–∫–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        // audioData.level = THREE.MathUtils.lerp(material.uniforms.uAudioLevel.value, audioData.level, 0.2);
    }

    // --- –û–ë–ù–û–í–õ–ï–ù–ò–ï –®–ï–ô–î–ï–†–ê ---
    material.uniforms.uTime.value = elapsedTime;
    // –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–≤—É–∫–∞ –≤ —à–µ–π–¥–µ—Ä
    material.uniforms.uAudioLevel.value = audioData.level;


    controls.update();
    renderer.render(scene, camera);
}

// Handle Resize
window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});

// –ó–∞–ø—É—Å–∫
animate();

// –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ –∫–æ–Ω—Å–æ–ª–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
console.log("%cUNIT Core v0.2 Initialized.", "color: #0057FF; font-weight: bold;");
console.log("Audio reactivity enabled. High-res export ready.");
</script>

</body>
</html>